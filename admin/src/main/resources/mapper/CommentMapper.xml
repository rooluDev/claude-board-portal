<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ebrain.admin.mapper.CommentMapper">

    <resultMap id="CommentResultMap" type="CommentDto">
        <id property="commentId" column="comment_id"/>
        <result property="boardType" column="board_type"/>
        <result property="boardId" column="board_id"/>
        <result property="authorType" column="author_type"/>
        <result property="authorId" column="author_id"/>
        <result property="authorName" column="author_name"/>
        <result property="content" column="content"/>
        <result property="createdAt" column="created_at"/>
        <result property="editedAt" column="edited_at"/>
    </resultMap>

    <!-- 게시물의 댓글 목록 조회 -->
    <select id="findByBoard" resultMap="CommentResultMap">
        SELECT
            c.comment_id,
            c.board_type,
            c.board_id,
            c.author_type,
            c.author_id,
            c.content,
            c.created_at,
            c.edited_at,
            CASE
                WHEN c.author_type = 'admin' THEN a.admin_name
                WHEN c.author_type = 'member' THEN m.member_name
            END AS author_name
        FROM tb_comment c
        LEFT JOIN tb_admin a ON c.author_type = 'admin' AND c.author_id = a.admin_id
        LEFT JOIN tb_member m ON c.author_type = 'member' AND c.author_id = m.member_id
        WHERE c.board_type = #{boardType} AND c.board_id = #{boardId}
        ORDER BY c.created_at ASC
    </select>

    <!-- 댓글 작성 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="commentId">
        INSERT INTO tb_comment (board_type, board_id, author_type, author_id, content, created_at)
        VALUES (#{boardType}, #{boardId}, #{authorType}, #{authorId}, #{content}, NOW())
    </insert>

    <!-- 댓글 삭제 -->
    <delete id="delete">
        DELETE FROM tb_comment WHERE comment_id = #{commentId}
    </delete>
</mapper>
