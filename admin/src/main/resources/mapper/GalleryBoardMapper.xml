<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ebrain.admin.mapper.GalleryBoardMapper">

    <resultMap id="GalleryBoardResultMap" type="GalleryBoardDto">
        <id property="boardId" column="board_id"/>
        <result property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
        <result property="authorType" column="author_type"/>
        <result property="authorId" column="author_id"/>
        <result property="authorName" column="author_name"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="views" column="views"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createdAt" column="created_at"/>
        <result property="editedAt" column="edited_at"/>
    </resultMap>

    <!-- 목록 조회 -->
    <select id="findAll" resultMap="GalleryBoardResultMap">
        SELECT
            gb.board_id,
            gb.category_id,
            c.category_name,
            gb.author_type,
            gb.title,
            gb.views,
            gb.is_deleted,
            gb.created_at,
            CASE
                WHEN gb.author_type = 'admin' THEN a.admin_name
                WHEN gb.author_type = 'member' THEN m.name
            END AS author_name
        FROM tb_gallery_board gb
        JOIN tb_category c ON gb.category_id = c.category_id
        LEFT JOIN tb_admin a ON gb.author_type = 'admin' AND gb.author_id = a.admin_id
        LEFT JOIN tb_member m ON gb.author_type = 'member' AND gb.author_id = m.member_id
        <where>
            <if test="startDate != null">
                AND DATE(gb.created_at) &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND DATE(gb.created_at) &lt;= #{endDate}
            </if>
            <if test="categoryId != null and categoryId != -1">
                AND gb.category_id = #{categoryId}
            </if>
            <if test="searchText != null and searchText != ''">
                AND (gb.title LIKE CONCAT('%', #{searchText}, '%')
                     OR gb.content LIKE CONCAT('%', #{searchText}, '%'))
            </if>
        </where>
        ORDER BY
            <choose>
                <when test="sortBy == 'createdAt'">gb.created_at</when>
                <when test="sortBy == 'categoryId'">gb.category_id</when>
                <when test="sortBy == 'title'">gb.title</when>
                <when test="sortBy == 'views'">gb.views</when>
                <otherwise>gb.created_at</otherwise>
            </choose>
            <choose>
                <when test="sortDirection == 'ASC'">ASC</when>
                <otherwise>DESC</otherwise>
            </choose>
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="count" resultType="int">
        SELECT COUNT(*) FROM tb_gallery_board gb
        <where>
            <if test="startDate != null">
                AND DATE(gb.created_at) &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND DATE(gb.created_at) &lt;= #{endDate}
            </if>
            <if test="categoryId != null and categoryId != -1">
                AND gb.category_id = #{categoryId}
            </if>
            <if test="searchText != null and searchText != ''">
                AND (gb.title LIKE CONCAT('%', #{searchText}, '%')
                     OR gb.content LIKE CONCAT('%', #{searchText}, '%'))
            </if>
        </where>
    </select>

    <select id="findById" resultMap="GalleryBoardResultMap">
        SELECT
            gb.*,
            c.category_name,
            CASE
                WHEN gb.author_type = 'admin' THEN a.admin_name
                WHEN gb.author_type = 'member' THEN m.name
            END AS author_name
        FROM tb_gallery_board gb
        JOIN tb_category c ON gb.category_id = c.category_id
        LEFT JOIN tb_admin a ON gb.author_type = 'admin' AND gb.author_id = a.admin_id
        LEFT JOIN tb_member m ON gb.author_type = 'member' AND gb.author_id = m.member_id
        WHERE gb.board_id = #{boardId}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="boardId">
        INSERT INTO tb_gallery_board (
            category_id, author_type, author_id, title, content, views, is_deleted, created_at
        ) VALUES (
            #{categoryId}, #{authorType}, #{authorId}, #{title}, #{content}, 0, FALSE, NOW()
        )
    </insert>

    <update id="update">
        UPDATE tb_gallery_board SET
            category_id = #{categoryId},
            title = #{title},
            content = #{content},
            edited_at = NOW()
        WHERE board_id = #{boardId}
    </update>

    <update id="softDelete">
        UPDATE tb_gallery_board SET
            is_deleted = TRUE,
            content = '삭제된 게시물입니다.'
        WHERE board_id = #{boardId}
    </update>

    <update id="increaseViews">
        UPDATE tb_gallery_board
        SET views = views + 1
        WHERE board_id = #{boardId}
    </update>
</mapper>
