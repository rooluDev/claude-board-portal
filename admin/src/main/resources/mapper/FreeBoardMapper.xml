<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ebrain.admin.mapper.FreeBoardMapper">

    <resultMap id="FreeBoardResultMap" type="FreeBoardDto">
        <id property="boardId" column="board_id"/>
        <result property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
        <result property="authorType" column="author_type"/>
        <result property="authorId" column="author_id"/>
        <result property="authorName" column="author_name"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="views" column="views"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createdAt" column="created_at"/>
        <result property="editedAt" column="edited_at"/>
    </resultMap>

    <!-- 목록 조회 (검색 포함) -->
    <select id="findAll" resultMap="FreeBoardResultMap">
        SELECT
            fb.board_id,
            fb.category_id,
            c.category_name,
            fb.author_type,
            fb.title,
            fb.views,
            fb.is_deleted,
            fb.created_at,
            CASE
                WHEN fb.author_type = 'admin' THEN a.admin_name
                WHEN fb.author_type = 'member' THEN m.name
            END AS author_name
        FROM tb_free_board fb
        JOIN tb_category c ON fb.category_id = c.category_id
        LEFT JOIN tb_admin a ON fb.author_type = 'admin' AND fb.author_id = a.admin_id
        LEFT JOIN tb_member m ON fb.author_type = 'member' AND fb.author_id = m.member_id
        <where>
            <if test="startDate != null">
                AND DATE(fb.created_at) &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND DATE(fb.created_at) &lt;= #{endDate}
            </if>
            <if test="categoryId != null and categoryId != -1">
                AND fb.category_id = #{categoryId}
            </if>
            <if test="searchText != null and searchText != ''">
                AND (fb.title LIKE CONCAT('%', #{searchText}, '%')
                     OR fb.content LIKE CONCAT('%', #{searchText}, '%'))
            </if>
        </where>
        ORDER BY
            <choose>
                <when test="sortBy == 'createdAt'">fb.created_at</when>
                <when test="sortBy == 'categoryId'">fb.category_id</when>
                <when test="sortBy == 'title'">fb.title</when>
                <when test="sortBy == 'views'">fb.views</when>
                <otherwise>fb.created_at</otherwise>
            </choose>
            <choose>
                <when test="sortDirection == 'ASC'">ASC</when>
                <otherwise>DESC</otherwise>
            </choose>
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 총 개수 -->
    <select id="count" resultType="int">
        SELECT COUNT(*)
        FROM tb_free_board fb
        <where>
            <if test="startDate != null">
                AND DATE(fb.created_at) &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND DATE(fb.created_at) &lt;= #{endDate}
            </if>
            <if test="categoryId != null and categoryId != -1">
                AND fb.category_id = #{categoryId}
            </if>
            <if test="searchText != null and searchText != ''">
                AND (fb.title LIKE CONCAT('%', #{searchText}, '%')
                     OR fb.content LIKE CONCAT('%', #{searchText}, '%'))
            </if>
        </where>
    </select>

    <!-- 상세 조회 -->
    <select id="findById" resultMap="FreeBoardResultMap">
        SELECT
            fb.board_id,
            fb.category_id,
            c.category_name,
            fb.author_type,
            fb.author_id,
            fb.title,
            fb.content,
            fb.views,
            fb.is_deleted,
            fb.created_at,
            fb.edited_at,
            CASE
                WHEN fb.author_type = 'admin' THEN a.admin_name
                WHEN fb.author_type = 'member' THEN m.name
            END AS author_name
        FROM tb_free_board fb
        JOIN tb_category c ON fb.category_id = c.category_id
        LEFT JOIN tb_admin a ON fb.author_type = 'admin' AND fb.author_id = a.admin_id
        LEFT JOIN tb_member m ON fb.author_type = 'member' AND fb.author_id = m.member_id
        WHERE fb.board_id = #{boardId}
    </select>

    <!-- 작성 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="boardId">
        INSERT INTO tb_free_board (
            category_id,
            author_type,
            author_id,
            title,
            content,
            views,
            is_deleted,
            created_at
        ) VALUES (
            #{categoryId},
            #{authorType},
            #{authorId},
            #{title},
            #{content},
            0,
            FALSE,
            NOW()
        )
    </insert>

    <!-- 수정 -->
    <update id="update">
        UPDATE tb_free_board SET
            category_id = #{categoryId},
            title = #{title},
            content = #{content},
            edited_at = NOW()
        WHERE board_id = #{boardId}
    </update>

    <!-- 소프트 삭제 -->
    <update id="softDelete">
        UPDATE tb_free_board SET
            is_deleted = TRUE,
            content = '삭제된 게시물입니다.'
        WHERE board_id = #{boardId}
    </update>

    <!-- 조회수 증가 -->
    <update id="increaseViews">
        UPDATE tb_free_board
        SET views = views + 1
        WHERE board_id = #{boardId}
    </update>
</mapper>
