<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ebrain.admin.mapper.NoticeBoardMapper">

    <resultMap id="NoticeBoardResultMap" type="NoticeBoardDto">
        <id property="boardId" column="board_id"/>
        <result property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
        <result property="authorId" column="author_id"/>
        <result property="authorName" column="author_name"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="views" column="views"/>
        <result property="isFixed" column="is_fixed"/>
        <result property="createdAt" column="created_at"/>
        <result property="editedAt" column="edited_at"/>
    </resultMap>

    <!-- 목록 조회 (검색 포함) -->
    <select id="findAll" resultMap="NoticeBoardResultMap">
        SELECT
            nb.board_id,
            nb.category_id,
            c.category_name,
            nb.title,
            nb.views,
            nb.is_fixed,
            nb.created_at,
            a.admin_name AS author_name
        FROM tb_notice_board nb
        JOIN tb_category c ON nb.category_id = c.category_id
        JOIN tb_admin a ON nb.author_id = a.admin_id
        <where>
            <if test="startDate != null">
                AND DATE(nb.created_at) &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND DATE(nb.created_at) &lt;= #{endDate}
            </if>
            <if test="categoryId != null and categoryId != -1">
                AND nb.category_id = #{categoryId}
            </if>
            <if test="searchText != null and searchText != ''">
                AND (nb.title LIKE CONCAT('%', #{searchText}, '%')
                     OR nb.content LIKE CONCAT('%', #{searchText}, '%'))
            </if>
        </where>
        ORDER BY
            nb.is_fixed DESC,
            <choose>
                <when test="sortBy == 'createdAt'">nb.created_at</when>
                <when test="sortBy == 'categoryId'">nb.category_id</when>
                <when test="sortBy == 'title'">nb.title</when>
                <when test="sortBy == 'views'">nb.views</when>
                <otherwise>nb.created_at</otherwise>
            </choose>
            <choose>
                <when test="sortDirection == 'ASC'">ASC</when>
                <otherwise>DESC</otherwise>
            </choose>
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 총 개수 -->
    <select id="count" resultType="int">
        SELECT COUNT(*)
        FROM tb_notice_board nb
        <where>
            <if test="startDate != null">
                AND DATE(nb.created_at) &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND DATE(nb.created_at) &lt;= #{endDate}
            </if>
            <if test="categoryId != null and categoryId != -1">
                AND nb.category_id = #{categoryId}
            </if>
            <if test="searchText != null and searchText != ''">
                AND (nb.title LIKE CONCAT('%', #{searchText}, '%')
                     OR nb.content LIKE CONCAT('%', #{searchText}, '%'))
            </if>
        </where>
    </select>

    <!-- 상세 조회 -->
    <select id="findById" resultMap="NoticeBoardResultMap">
        SELECT
            nb.board_id,
            nb.category_id,
            c.category_name,
            nb.author_id,
            a.admin_name AS author_name,
            nb.title,
            nb.content,
            nb.views,
            nb.is_fixed,
            nb.created_at,
            nb.edited_at
        FROM tb_notice_board nb
        JOIN tb_category c ON nb.category_id = c.category_id
        JOIN tb_admin a ON nb.author_id = a.admin_id
        WHERE nb.board_id = #{boardId}
    </select>

    <!-- 작성 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="boardId">
        INSERT INTO tb_notice_board (
            category_id,
            author_id,
            title,
            content,
            is_fixed,
            views,
            created_at
        ) VALUES (
            #{categoryId},
            #{authorId},
            #{title},
            #{content},
            #{isFixed},
            0,
            NOW()
        )
    </insert>

    <!-- 수정 -->
    <update id="update">
        UPDATE tb_notice_board SET
            category_id = #{categoryId},
            title = #{title},
            content = #{content},
            is_fixed = #{isFixed},
            edited_at = NOW()
        WHERE board_id = #{boardId}
    </update>

    <!-- 삭제 -->
    <delete id="delete">
        DELETE FROM tb_notice_board WHERE board_id = #{boardId}
    </delete>

    <!-- 조회수 증가 -->
    <update id="increaseViews">
        UPDATE tb_notice_board
        SET views = views + 1
        WHERE board_id = #{boardId}
    </update>

    <!-- 고정 게시물 개수 -->
    <select id="countFixedNotices" resultType="int">
        SELECT COUNT(*)
        FROM tb_notice_board
        WHERE is_fixed = TRUE
    </select>
</mapper>
