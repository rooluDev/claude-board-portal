<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ebrain.admin.mapper.InquiryBoardMapper">

    <resultMap id="InquiryBoardResultMap" type="InquiryBoardDto">
        <id property="boardId" column="board_id"/>
        <result property="authorId" column="author_id"/>
        <result property="authorName" column="author_name"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="views" column="views"/>
        <result property="isSecret" column="is_secret"/>
        <result property="createdAt" column="created_at"/>
        <result property="editedAt" column="edited_at"/>
    </resultMap>

    <!-- 목록 조회 -->
    <select id="findAll" resultMap="InquiryBoardResultMap">
        SELECT
            ib.board_id,
            ib.author_id,
            m.member_name AS author_name,
            ib.title,
            ib.views,
            ib.is_secret,
            ib.created_at,
            CASE WHEN a.answer_id IS NOT NULL THEN TRUE ELSE FALSE END AS has_answer
        FROM tb_inquiry_board ib
        JOIN tb_member m ON ib.author_id = m.member_id
        LEFT JOIN tb_answer a ON ib.board_id = a.board_id
        <where>
            <if test="startDate != null">
                AND DATE(ib.created_at) &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND DATE(ib.created_at) &lt;= #{endDate}
            </if>
            <if test="searchText != null and searchText != ''">
                AND (ib.title LIKE CONCAT('%', #{searchText}, '%')
                     OR ib.content LIKE CONCAT('%', #{searchText}, '%'))
            </if>
        </where>
        ORDER BY
            <choose>
                <when test="sortBy == 'createdAt'">ib.created_at</when>
                <when test="sortBy == 'title'">ib.title</when>
                <when test="sortBy == 'views'">ib.views</when>
                <otherwise>ib.created_at</otherwise>
            </choose>
            <choose>
                <when test="sortDirection == 'ASC'">ASC</when>
                <otherwise>DESC</otherwise>
            </choose>
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 총 개수 -->
    <select id="count" resultType="int">
        SELECT COUNT(*)
        FROM tb_inquiry_board ib
        <where>
            <if test="startDate != null">
                AND DATE(ib.created_at) &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND DATE(ib.created_at) &lt;= #{endDate}
            </if>
            <if test="searchText != null and searchText != ''">
                AND (ib.title LIKE CONCAT('%', #{searchText}, '%')
                     OR ib.content LIKE CONCAT('%', #{searchText}, '%'))
            </if>
        </where>
    </select>

    <!-- 상세 조회 -->
    <select id="findById" resultMap="InquiryBoardResultMap">
        SELECT
            ib.board_id,
            ib.author_id,
            m.member_name AS author_name,
            ib.title,
            ib.content,
            ib.views,
            ib.is_secret,
            ib.created_at,
            ib.edited_at
        FROM tb_inquiry_board ib
        JOIN tb_member m ON ib.author_id = m.member_id
        WHERE ib.board_id = #{boardId}
    </select>

    <!-- 조회수 증가 -->
    <update id="increaseViews">
        UPDATE tb_inquiry_board
        SET views = views + 1
        WHERE board_id = #{boardId}
    </update>
</mapper>
